name: Release

on:
  push:
    branches:
      - main
    tags:
      - '*'

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    name: Windows
    runs-on: windows-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Build
        shell: bash
        run: cargo build -p koharu --release --verbose
      - name: Prepare distribution folder
        shell: bash
        run: |
          mkdir dist
          cp target/release/koharu.exe dist/
          cp target/release/*.dll dist/
      - name: Pack
        shell: bash
        run: |
          dotnet tool update -g vpk
          vpk pack -u Koharu -v ${{ github.ref_name }} -p ${{ github.workspace }}/dist -e koharu.exe --azureTrustedSignFile ${{ github.workspace }}/signing/metadata.json
          vpk upload github --repoUrl https://github.com/${{ github.repository }} --publish --releaseName ${{ github.ref_name }} --tag ${{ github.ref_name }} --token ${{ secrets.GITHUB_TOKEN }} --merge
