name: Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always
  CUDA_COMPUTE_CAP: 75

jobs:
  build-windows:
    name: Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - uses: Jimver/cuda-toolkit@master
        with:
          cuda: '12.9.1'
          method: 'network'
          sub-packages: '["cudart", "cublas", "cufft", "nvcc"]'
      - uses: ilammy/msvc-dev-cmd@v1
      - run: bun install
      - run: bun tauri build --features=cuda,cudnn,bundle
      - name: Prepare distribution folder
        shell: bash
        run: |
          mkdir dist
          cp target/release/koharu.exe dist/

      - name: Generate release notes
        run: bun git-cliff --current -o RELEASE_NOTES.md

      - name: Package
        shell: bash
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          dotnet tool update -g vpk
          vpk pack -u Koharu -v ${{ github.ref_name }} -p dist -e koharu.exe -i koharu/icons/icon.ico \
            --releaseNotes RELEASE_NOTES.md \
            --azureTrustedSignFile .github/signing/metadata.json
          vpk upload github \
            --repoUrl https://github.com/${{ github.repository }} \
            --releaseName ${{ github.ref_name }} \
            --tag ${{ github.ref_name }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --merge

      - name: Prepare bundled artifacts
        shell: bash
        run: |
          7z x Releases/Koharu-win-Portable.zip -obundled-artifacts
          cd bundled-artifacts
          cp ../scripts/start_headless.bat ./start_headless.bat
          ./current/koharu.exe -d
          echo "Creating archive, check back in 20 years later"
          # skip blobs, let 7z copy the resolved symlink instead; and use spf to strip leading folder
          7z a ../Releases/Koharu-win-CUDA-Bundled.7z -x!models/*/blobs '-x!*.log' * .portable

      # upload Releases/Koharu-win-Bundled.zip to release artifacts
      # windows build step always finishes at the end, so we assume everything is ready at this point
      - name: Upload Bundled Artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: Releases/Koharu-win-CUDA-Bundled.7z
          body_path: RELEASE_NOTES.md
        env:
          token: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: macOS
    runs-on: macos-latest
    outputs:
      dmg_name: ${{ steps.create_dmg.outputs.dmg_name }}
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun tauri build --features=metal,bundle
      - name: Prepare distribution folder
        run: |
          mkdir dist
          cp target/release/koharu dist/
      - name: Generate release notes
        run: bun git-cliff --current -o RELEASE_NOTES.md
      - name: Install Apple certificates and notary profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          INSTALLER_CERTIFICATE_BASE64: ${{ secrets.INSTALLER_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ""
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM: ${{ secrets.APPLE_TEAM }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # create variables for file paths
          CERT_BUILD_PATH=$RUNNER_TEMP/build_certificate.p12
          CERT_INSTALLER_PATH=$RUNNER_TEMP/installer_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # import certificates from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERT_BUILD_PATH
          echo -n "$INSTALLER_CERTIFICATE_BASE64" | base64 --decode -o $CERT_INSTALLER_PATH

          # create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # import certificates to keychain
          security import $CERT_BUILD_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security import $CERT_INSTALLER_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # create notarytool profile
          xcrun notarytool store-credentials --keychain $KEYCHAIN_PATH --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM" --password "$APPLE_PASSWORD" velopack-profile
      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '9.0.x'
      - name: Package
        run: |
          dotnet tool update -g vpk
          vpk pack -u Koharu -v ${{ github.ref_name }} -p dist -e koharu -i koharu/icons/icon.icns \
            --releaseNotes RELEASE_NOTES.md \
            --signAppIdentity "Developer ID Application: Mayo Takanashi" \
            --signInstallIdentity "Developer ID Installer: Mayo Takanashi" \
            --notaryProfile "velopack-profile" \
            --keychain $RUNNER_TEMP/app-signing.keychain-db
          vpk upload github \
            --repoUrl https://github.com/${{ github.repository }} \
            --releaseName ${{ github.ref_name }} \
            --tag ${{ github.ref_name }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --merge
      - name: Create DMG from portable package
        id: create_dmg
        run: |
          rm -rf dmg-root
          mkdir -p dmg-root
          ditto -x -k Releases/Koharu-osx-Portable.zip dmg-root
          ln -s /Applications dmg-root/Applications

          case "${RUNNER_ARCH}" in
            ARM64) ARCH_SUFFIX="arm64" ;;
            X64) ARCH_SUFFIX="x64" ;;
            *) ARCH_SUFFIX="$(echo "${RUNNER_ARCH}" | tr '[:upper:]' '[:lower:]')" ;;
          esac

          DMG_NAME="Koharu-osx-${ARCH_SUFFIX}.dmg"
          hdiutil create -volname "Koharu" -srcfolder dmg-root -ov -format UDZO "Releases/${DMG_NAME}"
          echo "dmg_name=${DMG_NAME}" >> "$GITHUB_OUTPUT"

      - name: Upload DMG Artifact
        uses: softprops/action-gh-release@v2
        with:
          files: Releases/${{ steps.create_dmg.outputs.dmg_name }}
        env:
          token: ${{ secrets.GITHUB_TOKEN }}

  update-release-body:
    name: Update Release Body
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - name: Generate release notes
        run: bun git-cliff --current -o RELEASE_NOTES.md
      - name: Append download matrix
        env:
          RELEASE_TAG: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
          MACOS_DMG: ${{ needs.build-macos.outputs.dmg_name }}
        run: |
          BASE_URL="https://github.com/${REPO}/releases/download/${RELEASE_TAG}"
          cat <<EOF >> RELEASE_NOTES.md

          ## Download based on your OS

          | OS | Download |
          | --- | --- |
          | Windows | [Setup x64](${BASE_URL}/Koharu-win-Setup.exe) 路 [Portable x64](${BASE_URL}/Koharu-win-Portable.zip) 路 [CUDA Bundled x64](${BASE_URL}/Koharu-win-CUDA-Bundled.7z) |
          | macOS | [DMG](${BASE_URL}/${MACOS_DMG}) 路 [Setup PKG](${BASE_URL}/Koharu-osx-Setup.pkg) 路 [Portable ZIP](${BASE_URL}/Koharu-osx-Portable.zip) |
          | Linux | Build from source ([README](https://github.com/${REPO}/blob/main/README.md#development)) |
          EOF
      - name: Publish merged release notes
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTES.md
        env:
          token: ${{ secrets.GITHUB_TOKEN }}
