name: Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    name: Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build
        shell: bash
        run: cargo build --bin koharu --features=cuda --release --verbose
      - name: Prepare distribution folder
        shell: bash
        run: |
          mkdir dist
          cp target/release/koharu.exe dist/
          cp target/release/*.dll dist/
      - name: Release
        shell: bash
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          dotnet tool update -g vpk
          vpk pack -u Koharu -v ${{ github.ref_name }} -p dist -e koharu.exe --azureTrustedSignFile signing/metadata.json
          vpk upload github --repoUrl https://github.com/${{ github.repository }} --publish --releaseName ${{ github.ref_name }} --tag ${{ github.ref_name }} --token ${{ secrets.GITHUB_TOKEN }} --merge
